<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª â€” ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
 /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ù„Ø¹Ù†Ø§Ø¨ÙŠ ÙˆØ§Ù„Ø°Ù‡Ø¨ÙŠ */
 :root {
 --qatar-burgundy: #800020; /* Ø¹Ù†Ø§Ø¨ÙŠ Ø£Ø³Ø§Ø³ÙŠ */
 --qatar-gold: #D4AF37; /* Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø¥Ø¨Ø±Ø§Ø² */
 --bg-light: #FFFFFF; /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ */
 --text-dark: #1f2937; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø¯Ø§ÙƒÙ† */
 }
 body {
 font-family: 'Cairo', ui-sans-serif, system-ui;
 background-color: #F8F9FA;
 color: var(--text-dark);
 }
 .q-card {
 background-color: var(--bg-light);
 border: 1px solid #E5E7EB;
 box-shadow: 0 4px 12px rgba(0,0,0,0.06);
 }
 .btn-primary {
 background-color: var(--qatar-burgundy);
 color: white;
 transition: background-color 0.3s, transform 0.1s;
 }
 .btn-primary:hover {
 background-color: #A61E4D;
 transform: translateY(-1px);
 }
 .rec-btn {
 width: 64px; height: 64px; border-radius: 9999px;
 display: flex; align-items: center; justify-content: center;
 background-color: #EF4444;
 box-shadow: 0 4px 8px rgba(239, 68, 68, 0.5);
 transition: all 0.2s;
 }
 .rec-btn[data-state="recording"] {
  background-color: #B91C1C;
  animation: pulse-red 1.5s infinite;
 }
 @keyframes pulse-red {
 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
 }
 .wave-container {
 height: 48px; 
 background-color: #F3F4F6;
 border-radius: 8px;
 overflow: hidden;
 border: 1px solid #D1D5DB;
 }
 textarea, input[type="text"], input[type="email"], input[type="password"], input[type="radio"] {
 background-color: #FFFFFF !important;
 border: 1px solid #D1D5DB !important;
 color: var(--text-dark) !important;
 }
 .option-label {
  background-color: #F8F9FA;
  border: 1px solid #E5E7EB;
  transition: all 0.2s;
 }
 .option-label:hover {
  background-color: #EFF6FF;
  border-color: #BFDBFE;
 }
 .option-radio:checked + .option-label {
  border-color: var(--qatar-burgundy);
  background-color: #FEE2E2;
  box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.3);
 }
 #timerBox {
  background-color: #FEF3C7;
  border: 2px solid var(--qatar-gold);
  padding: 1rem;
  border-radius: 12px;
  text-align: center;
  margin-bottom: 1.5rem;
 }
 #timerBox h3 {
  color: var(--text-dark);
  font-weight: 700;
  margin-bottom: 0.5rem;
 }
 #countdownTimer {
  font-size: 2.2rem;
  font-weight: 900;
  color: var(--qatar-burgundy);
  font-family: 'Cairo', monospace;
 }
 #timerBox.danger {
  background-color: #FEE2E2;
  border-color: #EF4444;
 }
 #progressInner {
  background-color: var(--qatar-burgundy);
  transition: width 0.5s ease-in-out;
}
</style>
<script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']] // Ù„ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù…ÙˆØ² Ø¯Ø§Ø®Ù„ $ $
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
<div class="max-w-7xl mx-auto p-6">
<header class="max-w-7xl mx-auto p-6"> 
<div class="flex items-center justify-between mb-4">
    <div class="logo-box q-card p-3 rounded-xl border-none flex items-center gap-3 order-2 mx-auto">
        <img src="/exams/logo.svg" alt="logo" class="h-12 object-contain rounded" onerror="this.style.opacity=0.6;" />
        <div>
            <div class="font-extrabold text-gray-900 text-xl">Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
        </div>
    </div>

    <div class="flex items-center gap-4 order-1">
        <button id="openRegBtn" class="px-5 py-2 rounded-xl border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition hidden">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    </div>
</div>
</header>
<main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <div class="lg:col-span-3 mb-6">
        <div class="text-gray-800 text-2xl font-bold border-r-4 border-qatar-burgundy pr-3" id="examTitle">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†...</div>
    </div>
    
    <section class="lg:col-span-3">
        <h2 class="text-3xl font-bold mb-6 text-gray-800 border-r-4 border-qatar-burgundy pr-3">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø·Ø±ÙˆØ­Ø©</h2>
        <div id="questionsContainer" class="space-y-8">
            <div class="text-center text-gray-500 p-8 q-card rounded-xl" id="initialLoadingMessage">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†...</div>
        </div>
    </section>

    <aside class="lg:col-span-1 q-card p-6 rounded-2xl text-gray-700 sticky top-6 self-start">
        <h3 class="font-extrabold text-xl mb-4 border-b border-gray-200 pb-3 text-qatar-burgundy">Ù„ÙˆØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h3>
        
        <div id="timerBox" class="hidden">
            <h3>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</h3>
            <div id="countdownTimer">00:00:00</div>
        </div>

        <div class="space-y-3">
            <p class="text-sm">
                <span class="font-bold text-gray-800">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</span>
                <span class="text-gray-500 block" id="examInfo">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†...</span>
            </p>
            <div class="text-sm text-gray-500">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø¯Ù…</div>
            <div id="progressBar" class="w-full bg-gray-200 rounded-full h-3 mt-2 overflow-hidden">
                <div id="progressInner" class="h-full rounded-full bg-qatar-burgundy shadow-inner" style="width:0%"></div>
            </div>
            <div class="text-right text-xs pt-1 text-qatar-burgundy font-semibold" id="progressText">0% Ù…ÙƒØªÙ…Ù„</div>
        </div>
        
        <div class="mt-6 pt-4 border-t border-gray-200">
            <button id="finishExamBtn" class="btn-primary w-full p-3 rounded-xl font-bold text-lg transition duration-200">
                Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            </button>
        </div>
    </aside>
</main>
 <footer class="mt-12 text-center text-gray-500 pt-4 border-t border-gray-200">Â© Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª â€” ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</footer>
</div>

 <div id="regModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
 <div class="bg-white rounded-2xl w-full max-w-md p-8 shadow-2xl">
 <h3 class="text-2xl font-bold mb-6 text-qatar-burgundy">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
 <form id="regForm" class="space-y-4">
  <input required type="text" id="reg_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full p-3 border rounded-lg focus:ring-qatar-burgundy focus:border-qatar-burgundy" />
  <input required type="email" id="reg_email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full p-3 border rounded-lg focus:ring-qatar-burgundy focus:border-qatar-burgundy" />
  <input required type="password" id="reg_pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-3 border rounded-lg focus:ring-qatar-burgundy focus:border-qatar-burgundy" />
  <div class="flex gap-3 pt-2">
  <button type="submit" class="flex-1 btn-primary p-3 rounded-lg font-semibold">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
  <button type="button" id="closeReg" class="flex-1 border border-gray-300 text-gray-700 p-3 rounded-lg hover:bg-gray-100 transition">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
 </form>
 </div>
</div>

<template id="questionTemplate">
 <article class="q-card p-6 rounded-2xl text-gray-800 shadow-xl" data-question-id="">
 <header class="flex items-start justify-between gap-4 mb-5 border-b border-gray-200 pb-4">
  <div>
  <div class="text-sm text-gray-500 font-semibold">Ø³Ø¤Ø§Ù„ <span class="q-index"></span></div>
  <h2 class="q-text font-extrabold text-xl mt-1"></h2>
  <div class="text-sm text-gray-600 font-medium q-section-title"></div>
  </div>
 </header>

 <div class="answer-area space-y-4">
  <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
  
  <div class="flex flex-col items-center flex-shrink-0 audio-controls-group">
   <button class="rec-btn text-2xl text-white" title="Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¬ÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù" data-state="idle">
   ğŸ™ï¸
   </button>
   <div class="text-xs mt-2 text-gray-500 text-center recording-timer">00:00</div>
  </div>

  <div class="flex-1 w-full space-y-3">
   
   <div class="wave-container mb-2">
    <canvas class="wave-canvas w-full h-12" height="48"></canvas>
   </div>
   
   <div class="audio-player-wrapper hidden bg-gray-100 p-3 rounded-lg flex items-center gap-3">
    <audio class="audio-player flex-1" controls></audio>
    <button class="clear-audio text-red-500 text-sm hover:underline">Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
   </div>

   <textarea class="text-input w-full p-3 rounded-lg focus:ring-1 focus:ring-qatar-burgundy" placeholder="Ø£Ùˆ Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..." rows="3"></textarea>
  </div>

  </div>
  <button class="submit-answer btn-primary p-2 px-4 rounded-lg text-sm">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
  <p class="text-red-500 text-sm mt-2 submission-error hidden">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.</p>
 </div>
 
 <div class="options-area space-y-3 pt-4 border-t border-gray-200 hidden">
  <p class="text-gray-600 font-semibold mb-2">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</p>
  <button class="submit-option btn-primary p-2 px-4 rounded-lg text-sm mt-4">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</button>
  <p class="text-red-500 text-sm mt-2 submission-error hidden">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.</p>
 </div>
 
 <div class="text-xs text-gray-500 mt-4 pt-3 border-t border-gray-200">
  Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: <span class="recording-state text-qatar-burgundy font-semibold">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
 </div>
 </article>
</template>

<script>
 
 // 1. Ø§Ø³ØªØ®Ù„Ø§Øµ examId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©
 const pathSegments = window.location.pathname.split('/');
 // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† examId Ù…ÙˆØ¬ÙˆØ¯
 const examId = pathSegments.length > 2 ? pathSegments[2] : null; 
 
 // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ù‚Ø±Ø§Ø¡Ø© applicant_id Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… (Query Parameters)
 const urlParams = new URLSearchParams(window.location.search);
 const applicantIdFromURL = urlParams.get('applicant_id');
 
 // 2. ØªØ¹Ø±ÙŠÙ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù€ API (Ø§Ù„Ù…ÙØªØ±Ø¶ Ø£Ù†Ù‡Ø§ ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ server.js)
 const API = {
 exam: `/api/exams/${examId}`,
 questions: `/api/exams/${examId}/questions`,
 options: `/api/questions/options`, 
 uploadAudio: '/api/upload/audio',
 answers: '/api/answers',
 register: '/api/applicant/register' 
 };

 // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ø®ØªØµØ§Ø±
 const $ = (s, el=document) => el.querySelector(s);
 const progressInner = $('#progressInner');
 const progressText = $('#progressText');
 const questionsContainer = $('#questionsContainer');
 const timerBox = $('#timerBox');
 const countdownTimer = $('#countdownTimer');
 const examTitleEl = $('#examTitle');

 let totalQuestions = 0;
 let answeredQuestions = 0;
 let examEndTime = null; 
 let timerInterval;
 let answeredQuestionIds = new Set();
 // ===================================
 // ğŸ›¡ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© (Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù…Ø§Ù†)
 // ===================================
 const validationToken = sessionStorage.getItem('examValidationToken'); 
 // ğŸ›‘ Ø§Ø³ØªØ®Ø¯Ø§Ù… applicantId Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
 const applicantId = applicantIdFromURL;
 const examEndTimeISO = sessionStorage.getItem('examEndTime');

 if (!examId || !validationToken || !applicantId || !examEndTimeISO) {
  questionsContainer.innerHTML = '<div class="text-center text-red-700 p-8 q-card rounded-xl">âŒ **ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ**. ÙŠØ¬Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± ØµÙØ­Ø© Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹. Ø¬Ø§Ø±ÙŠ ØªÙˆØ¬ÙŠÙ‡Ùƒ...</div>';
  $('#openRegBtn').classList.remove('hidden'); 
  
  setTimeout(() => {
   // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† (applicant-exam.html)
   window.location.href = `/applicant-exam`; 
  }, 3000);
  throw new Error("Security check failed, redirecting.");
 }

  examEndTime = new Date(examEndTimeISO); 

 // ===================================
 // â±ï¸ Ù…Ø¤Ù‚Øª Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
 // ===================================
 function startTimer() {
  timerBox.classList.remove('hidden');
  
  const updateCountdown = () => {
   const now = new Date().getTime();
   const distance = examEndTime.getTime() - now; 

   if (distance < 1000) { 
    clearInterval(timerInterval);
    countdownTimer.textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";
    
    // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    document.querySelectorAll('.submit-answer, .submit-option, .rec-btn').forEach(btn => {
     btn.disabled = true;
     btn.classList.add('opacity-50', 'cursor-not-allowed');
    });
    document.querySelectorAll('.submission-error').forEach(el => el.classList.remove('hidden'));
    
    alert("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†! Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.");
    return;
   }

   const hours = Math.floor(distance / (1000 * 60 * 60));
   const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
   const seconds = Math.floor((distance % (1000 * 60)) / 1000);

   const timeStr = 
    String(hours).padStart(2, '0') + ":" +
    String(minutes).padStart(2, '0') + ":" +
    String(seconds).padStart(2, '0');
   
   countdownTimer.textContent = timeStr;

   if (distance < 5 * 60 * 1000) { 
    timerBox.classList.add('danger');
   } else {
    timerBox.classList.remove('danger');
   }
  };
  
  timerInterval = setInterval(updateCountdown, 1000);
  updateCountdown();
 }


 // ===================================
 // ğŸ“Š Ø¯ÙˆØ§Ù„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
 // ===================================
 function updateProgress() {
  if (totalQuestions === 0) {
   progressInner.style.width = '0%';
   progressText.textContent = '0% Ù…ÙƒØªÙ…Ù„';
   return;
  }
  const progress = Math.round((answeredQuestions / totalQuestions) * 100);
  progressInner.style.width = `${progress}%`;
  progressText.textContent = `${progress}% Ù…ÙƒØªÙ…Ù„`;
 }
 
  // Ù„Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ·
 function markAsAnswered(questionId) {
  if (answeredQuestionIds.has(questionId)) {
   return; // ØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„ÙŠÙ‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù„Ø§ ØªØ²Ø¯ Ø§Ù„Ø¹Ø¯Ø¯
  }
  answeredQuestionIds.add(questionId);
  answeredQuestions = answeredQuestionIds.size; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯ Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  updateProgress();
}

 // ... (Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© loadExam)

// ===================================
// ğŸ Ø¯Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
// ===================================
async function finishExamAndSubmitAll() {
    // Ø§ÙØªØ±Ø¶ Ø£Ù† applicantId Ù…ÙØ¹Ø±Ù‘Ù ÙˆÙ…ØªØ§Ø­ Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§ Ø£Ùˆ Ù…Ù† localStorage
    const applicantId = localStorage.getItem('applicantId'); 
    
Â  Â  const finishBtn = $('#finishExamBtn');
Â  Â  finishBtn.disabled = true;
Â  Â  finishBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 30 Ø«Ø§Ù†ÙŠØ©)...';
Â  Â  finishBtn.classList.add('opacity-50', 'cursor-not-allowed');

Â  Â  const questions = Array.from(document.querySelectorAll('article[data-question-id]'));
Â  Â  
Â  Â  // Ø¥ÙŠØ¬Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§ (Ù„Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨ØªÙ‡ Ø¨Ø¹Ø¯)
Â  Â  const submitButtons = questions.reduce((acc, article) => {
Â  Â  Â  Â  const typeEl = article.querySelector('.q-section-title');
Â  Â  Â  Â  const stateEl = article.querySelector('.recording-state');

Â  Â  Â  Â  // Ù„Ø§ Ù†Ø­Ø§ÙˆÙ„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø­ÙØ¸Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
Â  Â  Â  Â  if (stateEl && stateEl.textContent.includes('ØªÙ… Ø­ÙØ¸')) {
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 1. Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯
Â  Â  Â  Â  if (typeEl.textContent.includes('Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯')) {
Â  Â  Â  Â  Â  Â  const submitOptionBtn = article.querySelector('.submit-option');
Â  Â  Â  Â  Â  Â  Â // Ù†Ø±Ø³Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®ÙŠØ§Ø± Ù…ÙØ­Ø¯Ø¯ ÙˆÙ„Ù… ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø¨Ø¹Ø¯
Â  Â  Â  Â  Â  Â  if (submitOptionBtn && submitOptionBtn.dataset.mode !== 'edit' && article.querySelector('.option-radio:checked')) {
Â  Â  Â  Â  Â  Â  Â  Â  acc.push(submitOptionBtn);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†ØµÙŠØ©/Ø§Ù„ØµÙˆØªÙŠØ©
Â  Â  Â  Â  const submitAnswerBtn = article.querySelector('.submit-answer');
Â  Â  Â  Â  const textarea = article.querySelector('.text-input');
Â  Â  Â  Â  const hasAudioUrl = submitAnswerBtn && submitAnswerBtn.dataset.audioUrl;
Â  Â  Â  Â  
Â  Â  Â  Â  // Ù†Ø±Ø³Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ù… ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø¨Ø¹Ø¯
Â  Â  Â  Â  if (submitAnswerBtn && submitAnswerBtn.dataset.mode !== 'edit' && (textarea?.value || hasAudioUrl)) {
Â  Â  Â  Â  Â  Â  acc.push(submitAnswerBtn);
Â  Â  Â  Â  }
Â  Â  Â  Â  return acc;
Â  Â  }, []);

Â  Â  let successfulSubmissions = 0;
Â  Â  
Â  Â  // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
Â  Â  for (const btn of submitButtons) {
Â  Â  Â  Â  btn.click();
Â  Â  Â  Â  successfulSubmissions++;
Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 500));
Â  Â  }
Â  Â  
Â  Â  finishBtn.textContent = `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${successfulSubmissions} Ø¥Ø¬Ø§Ø¨Ø© Ù…ØªØ¨Ù‚ÙŠØ©. Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†...`;
    
    // ======================================================
    // â­ï¸â­ï¸ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© finished Ù„Ù„Ù…ØªÙ‚Ø¯Ù… ÙÙŠ DB â­ï¸â­ï¸
    // ======================================================
    if (applicantId) {
        try {
            const updateRes = await fetch(`/api/applicant/${applicantId}/finish`, {
                method: 'PATCH', // Ø§Ø³ØªØ®Ø¯Ø§Ù… PATCH Ù„ØªØ­Ø¯ÙŠØ« Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ finished: true })
            });
            
            if (!updateRes.ok) {
                console.warn('Failed to mark applicant as finished on server:', await updateRes.text());
            } else {
                 console.log('Applicant status successfully marked as finished.');
            }
        } catch (e) {
            console.error('Error during final applicant status update:', e);
        }
    } else {
         console.error('Applicant ID not found. Cannot mark as finished.');
    }
    // ======================================================
    
Â  Â  // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
Â  Â  if (timerInterval) clearInterval(timerInterval);
Â  Â  
Â  Â  // Ù…Ø³Ø­ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù†
Â  Â  sessionStorage.removeItem('examValidationToken');
Â  Â  sessionStorage.removeItem('examEndTime');

Â  Â  // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«ÙˆØ§Ù†ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø«Ù… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
Â  Â  await new Promise(resolve => setTimeout(resolve, 3000)); 
Â  Â  
Â  Â  // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø®ØµØµØ©
Â  Â  window.location.href = '/exams/finished';
}
// ğŸš¦ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØ³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù„Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
document.addEventListener('DOMContentLoaded', () => {
    const finishBtn = $('#finishExamBtn');
    if (finishBtn) {
        finishBtn.addEventListener('click', finishExamAndSubmitAll);
    }
});

// ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø¯ÙˆØ§Ù„)
 // ===================================
 // ğŸ“¤ Ø¯ÙˆØ§Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 // ===================================
async function loadExam() {
  try {
    const res = await fetch(API.exam);
    if (!res.ok) throw new Error('Failed to load exam details');
    const exam = await res.json();
    
    // â­ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ø³Ù…: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    const currentYear = new Date().getFullYear();
    const nextYear = currentYear + 1;
    
    const formattedTitle = `
      Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ† ${currentYear}/${nextYear} Ù„ØªØ®ØµØµ (${exam.title || 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± Ù…ØªÙˆÙØ±'}) # ${examId}
    `;
    
    examTitleEl.textContent = formattedTitle.trim(); // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯
    $('#examInfo').textContent = exam.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­.';
  } catch (e) {
    console.error('Error loading exam info:', e);
    examTitleEl.textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†';
    $('#examInfo').textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
  }
}

 async function loadQuestions() {
 try {
  // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¨Ù†Ø§Ø¡ Ø±Ø§Ø¨Ø· API Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù…Ø¹ Query Parameter
  const questionsApiUrl = `${API.questions}?applicant_id=${applicantId}`;

  const res = await fetch(questionsApiUrl);
  if (!res.ok) throw new Error('Failed to load questions');
  const questions = await res.json();
  totalQuestions = questions.length;
  renderQuestions(questions);
  updateProgress();
  // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
  const msg = $('#initialLoadingMessage');
  if(msg) msg.remove();
 } catch(e) {
  console.error(e);
  questionsContainer.innerHTML = '<div class="text-center text-red-700 p-8 q-card rounded-xl">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† server.js Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆÙˆØµÙ„Ø© API ØµØ­ÙŠØ­Ø©.</div>';
 }
 }

 // ===================================
 // ğŸ¨ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„Ø¹Ø±Ø¶
 // ===================================
// ===================================
// ğŸ¨ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„Ø¹Ø±Ø¶ - Ø¨Ø¹Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨answeredQuestions
// ===================================
function renderQuestions(list) {
console.log("âœ… renderQuestions started, list length:", list.length);
const tpl = $('#questionTemplate');
if (!tpl) {
  console.error("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨ #questionTemplate ÙÙŠ Ø§Ù„ØµÙØ­Ø©!");
  questionsContainer.innerHTML = '<div class="text-center text-red-700 p-8 q-card rounded-xl">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©.</div>';
  return;
}
const container = $('#questionsContainer');
container.innerHTML = '';

// ğŸ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
answeredQuestions = 0; 
answeredQuestionIds.clear(); // ğŸ†• Ù…Ø³Ø­ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù…
// ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
const sections = list.reduce((acc, q) => {
 const sectionId = q.section_id || 'no_section'; 
 if (!acc[sectionId]) {
 acc[sectionId] = { title: q.section_title || 'Ø£Ø³Ø¦Ù„Ø© Ø¹Ø§Ù…Ø©', questions: [] };
 }
 acc[sectionId].questions.push(q);
 return acc;
}, {});

let questionIndex = 1;

for (const sectionId in sections) {
 const section = sections[sectionId];
 
 // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙƒØ¨ÙŠØ±
 const sectionHeader = document.createElement('h2');
 sectionHeader.className = 'text-3xl font-extrabold text-qatar-burgundy mt-10 mb-6 border-b-2 border-qatar-burgundy pb-2';
 sectionHeader.textContent = `Ø§Ù„Ù‚Ø³Ù…: ${section.title}`;
 container.appendChild(sectionHeader);

 section.questions.forEach((q) => {
 const node = tpl.content.cloneNode(true);
 const article = node.querySelector('article');
 
 article.dataset.questionId = q.id;
 node.querySelector('.q-index').textContent = questionIndex++;
 node.querySelector('.q-text').innerHTML = q.text;

 container.appendChild(node);

if (window.MathJax && typeof MathJax.typesetPromise === "function") {
  MathJax.typesetPromise([article]).catch(err => console.warn("MathJax error:", err));
}
 
 // â­ï¸ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù‡Ù†Ø§!
 // ÙŠØªÙ… Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø¬Ø§Ø¨Ù‹Ø§ Ø¹Ù„ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ Ù†Øµ Ø£Ùˆ Ø±Ø§Ø¨Ø· ØµÙˆØªÙŠ Ø£Ùˆ Ø®ÙŠØ§Ø± Ù…Ø®ØªØ§Ø± Ù…Ø³Ø¨Ù‚Ù‹Ø§.
 if (q.answer_text || q.audio_url || q.answer_option_id) {
  answeredQuestionIds.add(q.id);
 }
 
 // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„
 let typeText = '';
 if (q.type === 'multiple_choice') typeText = 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯';
 else if (q.type === 'text') typeText = 'Ø¥Ø¬Ø§Ø¨Ø© Ù†ØµÙŠØ© (Ù…ØªØ§Ø­ ØµÙˆØªÙŠ)';
 else if (q.type === 'audio') typeText = 'Ø¥Ø¬Ø§Ø¨Ø© ØµÙˆØªÙŠØ© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©';
 else typeText = 'Ø¥Ø¬Ø§Ø¨Ø© Ù…ÙØªÙˆØ­Ø©';

 node.querySelector('.q-section-title').textContent = `Ø§Ù„Ù†ÙˆØ¹: ${typeText}`;
 
 
 const audioControls = node.querySelector('.audio-controls-group');
 const textInput = node.querySelector('.text-input');
 const optionsArea = node.querySelector('.options-area');
 const answerArea = node.querySelector('.answer-area');
 const submitAnswerBtn = node.querySelector('.submit-answer');


 if (q.type === 'multiple_choice') {
 optionsArea.classList.remove('hidden');
 answerArea.classList.add('hidden'); 
 loadOptions(q.id, optionsArea, q.answer_option_id); 

 } else if (q.type === 'audio') {
 // Ø¥Ø®ÙØ§Ø¡ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµÙˆØªÙŠØ© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
 textInput.classList.add('hidden'); 
 }
 
 bindRecorder(node, q);
 });
}

answeredQuestions = answeredQuestionIds.size;
}
// Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© loadOptions(questionId, container) { ... }

// â­ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø«Ø§Ù„Ø«: answerIdFromInitialLoad
async function loadOptions(questionId, container, answerIdFromInitialLoad) {
  // ... (Ø¬Ù„Ø¨ Ù…Ø­ØªÙˆÙ‰ Ù…Ø¨Ø¯Ø¦ÙŠ ÙˆØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„)
  const initialContentHtml = container.querySelector('p').outerHTML;
  const errorElHtml = container.querySelector('.submission-error').outerHTML;
  
  container.innerHTML = initialContentHtml + '<p class="text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª...</p>';
  
  try {
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    const optionsRes = await fetch(`${API.options}?question_id=${questionId}`);
    const options = await optionsRes.json();
    
    if (!optionsRes.ok) throw new Error('Failed to load options from server');

    // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙŠ ØªÙ… ØªÙ…Ø±ÙŠØ±Ù‡Ø§ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù†Ø¯Ø§Ø¡ API Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ø°ÙŠ Ø£Ø²Ù„Ù†Ø§Ù‡)
    const previousOptionId = answerIdFromInitialLoad || null; 
    const isAnswered = !!previousOptionId;
    

    const optionsHtml = options.map(opt => {
      // 3. ØªØ·Ø¨ÙŠÙ‚ Ø®Ø§ØµÙŠØªÙŠ checked Ùˆ disabled
      const isChecked = opt.id === previousOptionId ? 'checked' : ''; 
      const isDisabled = isAnswered ? 'disabled' : ''; // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      
      // 4. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù€ Label Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¹Ø·ÙŠÙ„)
      const labelClasses = isAnswered 
        ? 'opacity-50 cursor-not-allowed' 
        : 'cursor-pointer'; 

      return `
        <div class="flex items-center option-wrapper">
          <input type="radio" name="option_q${questionId}" id="option_${opt.id}" value="${opt.id}" class="hidden option-radio" ${isChecked} ${isDisabled} />
          <label for="option_${opt.id}" class="option-label flex-1 p-3 rounded-lg ${labelClasses}">${opt.text}</label>
      </div>
      `;
    }).join('');

    // âœ… 5. Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§ÙˆÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ¶Ø¨Ø· Ø§Ù„Ù…Ø³Ø§ÙØ© (space-y-3)
    container.innerHTML = `
      ${initialContentHtml}
      <div class="options-list-wrapper space-y-3 pt-4 border-t border-gray-200">
        ${optionsHtml}
      </div>
      <button class="submit-option btn-primary p-2 px-4 rounded-lg text-sm mt-4">${isAnswered ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±' : 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±'}</button>
      ${errorElHtml}
    `;

    // 6. Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚
    const newSubmitBtn = container.querySelector('.submit-option');
    const radioInputs = container.querySelectorAll(`input[name="option_q${questionId}"]`);
    const stateEl = container.closest('article').querySelector('.recording-state');

    if (isAnswered) {
      newSubmitBtn.dataset.mode = 'edit';
      stateEl.textContent = 'ØªÙ… Ø­ÙØ¸ Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…';
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ¹Ø·ÙŠÙ„/ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    const toggleOptionControls = (disable) => {
      radioInputs.forEach(input => {
        input.disabled = disable;
        const label = input.nextElementSibling;
        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ù€ Label Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø·ÙŠÙ„
        if (disable) {
          label.classList.add('opacity-50', 'cursor-not-allowed');
          label.classList.remove('cursor-pointer');
        } else {
          label.classList.remove('opacity-50', 'cursor-not-allowed');
          label.classList.add('cursor-pointer');
        }
      });
      if (disable) {
        newSubmitBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±';
        newSubmitBtn.dataset.mode = 'edit';
      } else {
        newSubmitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±';
        delete newSubmitBtn.dataset.mode;
      }
    };

    newSubmitBtn.addEventListener('click', async (e) => {
      // 1. Ù…Ù†Ø·Ù‚ "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±"
      if (newSubmitBtn.dataset.mode === 'edit') {
        toggleOptionControls(false); // ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        stateEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.';
        return;
      }

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙˆÙ‚Øª
      if (examEndTime && new Date().getTime() > examEndTime.getTime()) return;

      const selectedOption = container.querySelector(`input[name="option_q${questionId}"]:checked`);
      
      if (!selectedOption) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø®ÙŠØ§Ø± ÙˆØ§Ø­Ø¯.');
        return;
      }
      
      // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ API.answers)
      const currentApplicantId = applicantId; 
      stateEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±...';

      const payload = {
        exam_id: examId,
        question_id: questionId,
        applicant_id: currentApplicantId,
        answer_option_id: parseInt(selectedOption.value)
      };

      const postRes = await fetch(API.answers, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(payload) 
      });

      if (postRes.ok) {
        stateEl.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­ÙØ¸Ù‡ âœ…';
        markAsAnswered(questionId);
        // Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­: Ù†Ø¹Ø·Ù„ ÙˆÙ†ØºÙŠØ± Ø§Ù„Ø²Ø±
        toggleOptionControls(true);
      } else {
        stateEl.textContent = `ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âŒ. Ø®Ø·Ø£: ${postRes.statusText}`;
      }
    });

  } catch (e) {
    console.error('Error loading options:', e);
    container.innerHTML = initialContentHtml + '<p class="text-red-500">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ server.js ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
  }
} // ===================================
 // ğŸ™ï¸ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ (Web Audio API)
 // ===================================
 
 let mediaRecorder = null;
 let audioChunks = [];
 let stream = null;
 let audioContext = null;
 let analyser = null;
 let bufferLength = 0;
 
 // Ø¯Ø§Ù„Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ù…ÙˆØ¬Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©
 function drawWave(canvas, isRecording, data) {
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  
  ctx.clearRect(0, 0, width, height);
  
  if (isRecording && data && analyser) {
   analyser.getByteTimeDomainData(data);
   
   ctx.lineWidth = 2;
   ctx.strokeStyle = '#800020'; // Ø§Ù„Ø¹Ù†Ø§Ø¨ÙŠ
   ctx.beginPath();
   
   const sliceWidth = width * 1.0 / bufferLength;
   let x = 0;
   
   for (let i = 0; i < bufferLength; i++) {
    const v = data[i] / 128.0;
    const y = v * height / 2;
    
    if (i === 0) {
     ctx.moveTo(x, y);
    } else {
     ctx.lineTo(x, y);
    }
    
    x += sliceWidth;
   }
   
   ctx.lineTo(width, height / 2);
   ctx.stroke();
   
   requestAnimationFrame(() => drawWave(canvas, isRecording, data));
  }
 }
 
// ğŸ™ï¸ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ (Web Audio API)
// ... (Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø«Ù„ mediaRecorder, audioChunks, stream, audioContext, analyser, bufferLength)
// ... (Ø¯Ø§Ù„Ø© drawWave)


// ğŸ™ï¸ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ (Web Audio API)
// ... (Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©)

function bindRecorder(node, q) {
const recBtn = node.querySelector('.rec-btn');
const playerWrapper = node.querySelector('.audio-player-wrapper');
const audioPlayer = node.querySelector('.audio-player');
const clearAudioBtn = node.querySelector('.clear-audio');
const stateEl = node.querySelector('.recording-state');
const textarea = node.querySelector('.text-input');
const submitBtn = node.querySelector('.submit-answer');
const timerEl = node.querySelector('.recording-timer');
const canvas = node.querySelector('.wave-canvas');

let timer = 0;
let timerIntervalId;
let drawData;

// ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ù‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
const updateTimer = () => {
 timer++;
 const minutes = String(Math.floor(timer / 60)).padStart(2, '0');
 const seconds = String(timer % 60).padStart(2, '0');
 timerEl.textContent = `${minutes}:${seconds}`;
}

recBtn.addEventListener('click', async () => {
   // ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙˆÙ‚Øª
   if (examEndTime && new Date().getTime() > examEndTime.getTime()) return;

 if (recBtn.dataset.state === 'idle' || recBtn.dataset.state === 'stopped' || recBtn.dataset.state === 'recorded') {
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© recordedØŒ Ù†Ø¹ÙŠØ¯Ù‡Ø§ Ø¥Ù„Ù‰ idle/stopped Ù„Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
  if (recBtn.dataset.state === 'recorded') {
   recBtn.dataset.state = 'idle';
   // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
   submitBtn.dataset.audioUrl = ''; 
   audioPlayer.src = '';
   playerWrapper.classList.add('hidden');
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
  try {
  // Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
// ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­ Ù„ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ±Ù…ÙŠØ² Opus Ù…Ø¹ WebM
// Ù‡Ø°Ø§ ÙŠÙˆÙØ± Ø­Ø¬Ù… Ù…Ù„Ù Ø£ØµØºØ± Ø¨ÙƒØ«ÙŠØ± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©
// ğŸ’¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‡Ù…: ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¨Øª Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…
// 12000 bit/s = 12 kbps. Ù‡Ø°Ø§ ÙŠÙƒÙÙŠ Ù„Ø¬ÙˆØ¯Ø© ØµÙˆØª Ø¨Ø´Ø±ÙŠ ÙˆØ§Ø¶Ø­ Ø¬Ø¯Ù‹Ø§ ÙˆÙŠÙˆÙØ± Ø­Ø¬Ù… Ù…Ù„Ù ØµØºÙŠØ±.
const TARGET_BITRATE = 12000; // 12 kbps

try {
    mediaRecorder = new MediaRecorder(stream, { 
        mimeType: 'audio/webm;codecs=opus',
        audioBitsPerSecond: TARGET_BITRATE 
    });
} catch (e) {
    // ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ø¥Ø°Ø§ ÙØ´Ù„ OpusØŒ Ø³Ù†Ø¹ÙˆØ¯ Ù„Ù€ webm Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
    console.warn("Opus codec not supported, falling back to default webm.");
    try {
        mediaRecorder = new MediaRecorder(stream, { 
            mimeType: 'audio/webm',
            audioBitsPerSecond: TARGET_BITRATE
        });
    } catch (e2) {
        // Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£Ø®ÙŠØ± (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ù„ÙÙ‹Ø§ Ø¶Ø®Ù…Ù‹Ø§)
        mediaRecorder = new MediaRecorder(stream);
    }
}  audioChunks = [];
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ù„Ø±Ø³Ù…
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioContext.createAnalyser();
  const source = audioContext.createMediaStreamSource(stream);
  source.connect(analyser);
  analyser.fftSize = 2048;
  bufferLength = analyser.frequencyBinCount;
  drawData = new Uint8Array(bufferLength);
  
  mediaRecorder.ondataavailable = event => {
   audioChunks.push(event.data);
  };
  
  mediaRecorder.onstop = async () => {
  const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' }); 
   
   // 1. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØºÙ„
   const audioUrl = URL.createObjectURL(audioBlob);
   audioPlayer.src = audioUrl;
   playerWrapper.classList.remove('hidden');
   recBtn.dataset.state = 'recorded';
   recBtn.textContent = 'â–¶ï¸'; // ØªØºÙŠÙŠØ± Ø§Ù„Ø²Ø± Ù„Ù„ØªØ´ØºÙŠÙ„

   // 2. Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
   stateEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ...';
   const formData = new FormData();
   formData.append('audio', audioBlob, `audio_q${q.id}_a${applicantId}.webm`);
   formData.append('applicant_id', applicantId);
   formData.append('question_id', q.id);
   
   const uploadRes = await fetch(API.uploadAudio, {
   method: 'POST',
   body: formData
   });
   
   if (uploadRes.ok) {
   const uploadResult = await uploadRes.json();
   submitBtn.dataset.audioUrl = uploadResult.audioUrl; // Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±
   stateEl.textContent = 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­. Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.';
   } else {
   stateEl.textContent = 'âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
   }
   
   // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
   stream.getTracks().forEach(track => track.stop());
  };
  
  mediaRecorder.start();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„Ø¹Ø¯
  recBtn.dataset.state = 'recording';
  recBtn.textContent = 'ğŸ›‘';
  playerWrapper.classList.add('hidden');
  // submitBtn.dataset.audioUrl = ''; // ØªÙ… Ù…Ø³Ø­Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
  stateEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
  timer = 0;
  timerIntervalId = setInterval(updateTimer, 1000);
  drawWave(canvas, true, drawData);
  
  } catch (err) {
  console.error('Error accessing microphone:', err);
  stateEl.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù‡.';
  recBtn.dataset.state = 'idle';
  recBtn.textContent = 'ğŸ™ï¸';
  }
 } else if (recBtn.dataset.state === 'recording') {
  // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
  mediaRecorder.stop();
  clearInterval(timerIntervalId);
  recBtn.dataset.state = 'stopped';
  stateEl.textContent = 'ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
  drawWave(canvas, false); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ø³Ù…
 }
});

// Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ØŒ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
audioPlayer.addEventListener('ended', () => {
 if (recBtn.dataset.state === 'recorded') {
  recBtn.textContent = 'â–¶ï¸';
  stateEl.textContent = 'ØªÙ… Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„.';
 }
});

// Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
clearAudioBtn.addEventListener('click', () => {
 audioPlayer.src = '';
 playerWrapper.classList.add('hidden');
 recBtn.dataset.state = 'idle';
 recBtn.textContent = 'ğŸ™ï¸';
 submitBtn.dataset.audioUrl = '';
 timerEl.textContent = '00:00';
 stateEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
 // Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø°Ù ÙŠØ¬Ø¨ Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§
 q.audio_url = null; 
});

// ğŸ’¾ Ø¥Ø±Ø³Ø§Ù„ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†ØµÙŠØ©/Ø§Ù„ØµÙˆØªÙŠØ©
submitBtn.addEventListener('click', async (e) => {
 // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± ÙÙŠ ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„
 if (submitBtn.dataset.mode === 'edit') {
  textarea.disabled = false;
  recBtn.disabled = false;
  recBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  textarea.classList.remove('opacity-50');
  submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
  delete submitBtn.dataset.mode;
  // Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
  q.answer_text = null;
  q.audio_url = null;
  return;
 }

 // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
 if (examEndTime && new Date().getTime() > examEndTime.getTime()) return;

 const currentApplicantId = applicantId;
 const payload = {
  exam_id: examId,
  question_id: q.id,
  applicant_id: currentApplicantId,
  answer_text: textarea.value || null,
  audio_url: submitBtn.dataset.audioUrl || null
 };

 if (!payload.answer_text && !payload.audio_url) {
  stateEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ù†ØµÙŠØ© Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ Ø£ÙˆÙ„Ø§Ù‹.';
  return;
 }

 stateEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©...';
 const res = await fetch(API.answers, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(payload)
 });

 if (res.ok) {
  stateEl.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ­ÙØ¸Ù‡Ø§ âœ…';
  markAsAnswered(q.id);

  // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ (Ù„ØªÙØ§Ø¯ÙŠ Ø·Ù„Ø¨ API Ø¢Ø®Ø±)
  q.answer_text = payload.answer_text;
  q.audio_url = payload.audio_url;
  q.answer_option_id = null; // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø®ÙŠØ§Ø± Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯

  // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  textarea.disabled = true;
  recBtn.disabled = true;
  recBtn.classList.add('opacity-50', 'cursor-not-allowed');
  textarea.classList.add('opacity-50');
  submitBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
  submitBtn.dataset.mode = 'edit';
 } else {
  stateEl.textContent = `ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âŒ. Ø®Ø·Ø£: ${res.statusText}`;
 }
});

// ğŸ§  ÙˆØ¸ÙŠÙØ© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø©: ØªØ¹ØªÙ…Ø¯ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ø¹ Ø§Ù„Ø³Ø¤Ø§Ù„ (q)
function initializePreviousAnswerState() {
 // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†ØµÙŠØ© Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØª Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„ (ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† DB)
 if (q.answer_text || q.audio_url) {
   if (q.answer_text) textarea.value = q.answer_text;
   
   if (q.audio_url) {
    submitBtn.dataset.audioUrl = q.audio_url;
    playerWrapper.classList.remove('hidden');
    audioPlayer.src = q.audio_url; // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ù„Ù…Ø´ØºÙ„
    recBtn.dataset.state = 'recorded'; // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ "ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„"
    recBtn.textContent = 'â–¶ï¸';
   }

   // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"
   textarea.disabled = true;
   recBtn.disabled = true;
   recBtn.classList.add('opacity-50', 'cursor-not-allowed');
   textarea.classList.add('opacity-50');
   submitBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
   submitBtn.dataset.mode = 'edit';
   stateEl.textContent = 'ØªÙ… Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…';
 }
}
// ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
initializePreviousAnswerState();
}

 // ===================================
 // ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
 // ===================================
  // ÙŠØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù…Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ

  function initializeExam() {
    loadExam();
    loadQuestions(); // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø³ØªØ¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØªØ³ØªØ¯Ø¹ÙŠ MathJax.typesetPromise
    startTimer(); 
}
  if (examId && validationToken && applicantId && examEndTimeISO) {
   if (window.MathJax && MathJax.startup) {
        // Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ MathJax Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¶Ù…Ù† Ø£Ù† MathJax Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ loadQuestions
        MathJax.startup.promise.then(initializeExam);
    } else {
        // ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªØªØ¹Ø±Ù Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù„Ù‰ MathJax
        initializeExam();
    }
  }
</script>
</body>
</html>