<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ù…Ø§Ø±ÙˆÙ†) */
    .bg-\[\#800020\] { background-color: #800020; }
    .hover\:bg-\[\#9a1c35\]:hover { background-color: #9a1c35; }
    .border-\[\#800020\] { border-color: #800020; }
    .focus\:ring-\[\#800020\]:focus { --tw-ring-color: #800020; }
  </style>
</head>

<body class="bg-gray-100 font-sans text-gray-800 flex justify-center items-center min-h-screen p-4">
  <div class="w-full max-w-xl mx-auto bg-white shadow-2xl rounded-xl p-8 border-t-8 border-[#800020]">
    <h1 class="text-3xl font-extrabold text-[#800020] mb-8 text-center pb-4 border-b">
      Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
    </h1>

    <form id="questionForm" class="space-y-6">
      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† -->
      <div>
        <label for="exam_id" class="block mb-2 font-semibold text-gray-700">Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</label>
        <select id="exam_id" name="exam_id" required
          class="w-full border border-gray-300 bg-gray-50 text-gray-800 rounded-lg p-2 focus:ring-2 focus:ring-[#800020] focus:border-transparent">
          <option value="">â€” Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª â€”</option>
        </select>
      </div>

      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… -->
      <div>
        <label for="section_id" class="block mb-2 font-semibold text-gray-700">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label>
        <select id="section_id" name="section_id" required disabled
          class="w-full border border-gray-300 bg-gray-50 text-gray-800 rounded-lg p-2 focus:ring-2 focus:ring-[#800020] focus:border-transparent">
          <option value="">â€” Ø§Ø®ØªØ± Ø§Ù…ØªØ­Ø§Ù† Ø£ÙˆÙ„Ø§Ù‹ â€”</option>
        </select>
      </div>

      <!-- Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ -->
      <div>
        <label for="question_text" class="block mb-2 font-semibold text-gray-700">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
        <textarea id="question_text" name="question_text" rows="4" required
          class="w-full border border-gray-300 bg-gray-50 rounded-lg p-2 focus:ring-2 focus:ring-[#800020] focus:border-transparent"></textarea>
      </div>

      <!-- Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ -->
      <div>
        <label for="question_type" class="block mb-2 font-semibold text-gray-700">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
        <select id="question_type" name="question_type" required
          class="w-full border border-gray-300 bg-gray-50 text-gray-800 rounded-lg p-2 focus:ring-2 focus:ring-[#800020] focus:border-transparent">
          <option value="text">Ø³Ø¤Ø§Ù„ ÙƒØªØ§Ø¨ÙŠ (Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©)</option>
          <option value="multiple_choice">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
        </select>
      </div>

      <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯) -->
      <div id="optionsContainer" class="hidden border border-gray-200 rounded-lg p-4 bg-gray-50">
        <div class="flex items-center justify-between mb-3">
          <label class="font-semibold text-gray-700">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</label>
          <button type="button" id="addOption"
            class="bg-[#800020] hover:bg-[#9a1c35] text-white text-sm px-3 py-1 rounded-lg shadow transition">
            + Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±
          </button>
        </div>

        <div id="optionsList" class="space-y-2">
          <!-- ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù‡Ù†Ø§ -->
        </div>
      </div>

      <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
      <button type="submit" id="submitBtn"
        class="w-full bg-[#800020] text-white py-3 mt-6 rounded-lg hover:bg-[#9a1c35] transition font-bold text-lg shadow-md">
        Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„
      </button>
    </form>

    <p id="message" class="mt-6 text-center font-medium"></p>
  </div>

  <script>
    const examSelect = document.getElementById('exam_id');
    const sectionSelect = document.getElementById('section_id');
    const form = document.getElementById('questionForm');
    const submitBtn = document.getElementById('submitBtn');
    const messageElement = document.getElementById('message');
    const questionType = document.getElementById('question_type');
    const optionsContainer = document.getElementById('optionsContainer');
    const optionsList = document.getElementById('optionsList');
    const addOptionBtn = document.getElementById('addOption');

    // Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù€ API
    const API_EXAMS = '/api/exams';
    const API_SECTIONS = '/api/sections';
    const API_QUESTIONS = '/api/questions';

    // ====== ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ======
    function displayMessage(text, isSuccess = true) {
        messageElement.className = isSuccess 
            ? 'text-green-600 text-center mt-4 font-bold' 
            : 'text-red-600 text-center mt-4 font-bold';
        messageElement.textContent = (isSuccess ? 'âœ… ' : 'âŒ ') + text;
    }

    // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ======
    async function loadExams() {
      examSelect.innerHTML = '<option value="">â€” Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª â€”</option>';
      try {
        const res = await fetch(API_EXAMS);
        if (!res.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
        const exams = await res.json();
        
        examSelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† â€”</option>';
        if (exams.length > 0) {
            exams.forEach(exam => {
              const opt = document.createElement('option');
              opt.value = exam.id;
              opt.textContent = exam.title;
              examSelect.appendChild(opt);
            });
        } else {
            examSelect.innerHTML = '<option value="">â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© â€”</option>';
        }

      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª:", error);
        examSelect.innerHTML = '<option value="">â€” ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª â€”</option>';
        displayMessage('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø®Ø§Ø¯Ù….', false);
      }
    }

    // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ======
    async function loadSections(examId) {
      sectionSelect.innerHTML = '<option value="">â€” Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€”</option>';
      sectionSelect.disabled = true;
      if (!examId) return;
      
      try {
        const res = await fetch(`${API_SECTIONS}?exam_id=${examId}`);
        if (!res.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…');
        const sections = await res.json();
        
        sectionSelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… â€”</option>';
        if (sections.length > 0) {
          sections.forEach(sec => {
            const opt = document.createElement('option');
            opt.value = sec.id;
            opt.textContent = sec.title;
            sectionSelect.appendChild(opt);
          });
          sectionSelect.disabled = false;
        } else {
          sectionSelect.innerHTML = '<option value="">â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… â€”</option>';
        }
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:", error);
        sectionSelect.innerHTML = '<option value="">â€” Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ â€”</option>';
      }
    }

    // ====== Ø¹Ø±Ø¶ / Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ======
    questionType.addEventListener('change', e => {
      if (e.target.value === 'multiple_choice') {
        optionsContainer.classList.remove('hidden');
        if (optionsList.children.length === 0) {
            addOptionField(true);
            addOptionField(false);
            addOptionField(false);
        }
      } else {
        optionsContainer.classList.add('hidden');
        optionsList.innerHTML = '';
      }
    });

    // ====== Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯ ======
    addOptionBtn.addEventListener('click', () => addOptionField(false));

    function addOptionField(isCorrect = false) {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-2';
      div.innerHTML = `
        <input type="radio" name="correct_option" class="accent-[#800020]" ${isCorrect ? 'checked' : ''} />
        <input type="text" class="option-input flex-1 p-2 border border-gray-300 rounded focus:ring-2 focus:ring-[#800020]" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø®ÙŠØ§Ø±..." required />
        <button type="button" class="removeOption bg-gray-200 hover:bg-gray-300 text-sm px-2 py-1 rounded text-gray-700">âœ•</button>
      `;
      optionsList.appendChild(div);
      div.querySelector('.removeOption').addEventListener('click', () => div.remove());
    }

    // ====== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ======
    form.addEventListener('submit', async e => {
      e.preventDefault();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';
      messageElement.textContent = ''; 
      
      const qType = questionType.value;
      const questionText = document.getElementById('question_text').value.trim();

      let data = {
        section_id: sectionSelect.value,
        text: questionText, // <-- Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Server.js
        type: qType,
        order: 1
      };

      if (!data.section_id || !data.text) {
          displayMessage('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§Ù„Ù‚Ø³Ù… ÙˆÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„.', false);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„';
          return;
      }
      
      if (qType === 'multiple_choice') {
        const optionInputs = document.querySelectorAll('.option-input');
        const correctRadios = document.querySelectorAll('input[name="correct_option"]');
        const options = [];
        let hasCorrectAnswer = false;
        let validOptionCount = 0;

        optionInputs.forEach((input, i) => {
          const text = input.value.trim();
          if (text) {
            validOptionCount++;
            const is_correct = correctRadios[i].checked;
            options.push({ text, is_correct });
            if (is_correct) hasCorrectAnswer = true;
          }
        });

        if (validOptionCount < 2 || !hasCorrectAnswer) {
          displayMessage('ÙŠØ¬Ø¨ ØªÙˆÙÙŠØ± Ø®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØªØ­Ø¯ÙŠØ¯ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙˆØ§Ø­Ø¯Ø©.', false);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„';
          return;
        }

        data.options = options;
      }

      console.log("ğŸŸ¢ Data before submit:", data);

      try {
        const res = await fetch(API_QUESTIONS, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();

        if (res.ok && result.success) {
          displayMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
          form.reset();
          optionsContainer.classList.add('hidden');
          optionsList.innerHTML = '';
          loadSections(examSelect.value);
        } else {
          throw new Error(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        }
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", error);
        displayMessage(error.message, false);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„';
      }
    });

    // ====== Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ======
    examSelect.addEventListener('change', e => loadSections(e.target.value));
    
    // Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    loadExams();
  </script>
</body>
</html>
